<head>
  <meta content="text/html; charset=utf-8" http-equiv="content-type" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{html_report_name}} - TestReport</title>
  <style>
    body {
      background-color: #f2f2f2;
      color: #333;
      margin: 0 auto;
      width: 960px;
    }
    #summary {
      width: 960px;
      margin-bottom: 20px;
    }
    #summary th {
      background-color: skyblue;
      padding: 5px 12px;
    }
    #summary td {
      background-color: lightblue;
      text-align: center;
      padding: 4px 8px;
    }
    .details {
      width: 960px;
      margin-bottom: 20px;
    }
    .details th {
      background-color: skyblue;
      padding: 5px 12px;
    }
    .details tr .passed {
      background-color: lightgreen;
    }
    .details tr .failed {
      background-color: red;
    }
    .details tr .unchecked {
      background-color: gray;
    }
    .details td {
      background-color: lightblue;
      padding: 5px 12px;
    }
    .details .detail {
      background-color: lightgrey;
      font-size: smaller;
      padding: 5px 10px;
      line-height: 20px;
      text-align: left;
    }
    .details .success {
      background-color: greenyellow;
    }
    .details .error {
      background-color: red;
    }
    .details .failure {
      background-color: salmon;
    }
    .details .skipped {
      background-color: gray;
    }

    .button {
      font-size: 1em;
      padding: 6px;
      width: 4em;
      text-align: center;
      background-color: #06d85f;
      border-radius: 20px/50px;
      cursor: pointer;
      transition: all 0.3s ease-out;
    }
    a.button{
      color: gray;
      text-decoration: none;
      display: inline-block;
    }
    .button:hover {
      background: #2cffbd;
    }

    .overlay {
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      transition: opacity 500ms;
      visibility: hidden;
      opacity: 0;
      line-height: 25px;
    }
    .overlay:target {
      visibility: visible;
      opacity: 1;
    }

    .popup {
      margin: 70px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      width: 50%;
      position: relative;
      transition: all 3s ease-in-out;
    }

    .popup h2 {
      margin-top: 0;
      color: #333;
      font-family: Tahoma, Arial, sans-serif;
    }
    .popup .close {
      position: absolute;
      top: 20px;
      right: 30px;
      transition: all 200ms;
      font-size: 30px;
      font-weight: bold;
      text-decoration: none;
      color: #333;
    }
    .popup .close:hover {
      color: #06d85f;
    }
    .popup .content {
      max-height: 80%;
      overflow: auto;
      text-align: left;
    }
    .popup .separator {
      color:royalblue
    }

    @media screen and (max-width: 700px) {
      .box {
        width: 70%;
      }
      .popup {
        width: 70%;
      }
    }

    /* æŠ˜å å†…å®¹æ ·å¼ */
    .collapsible-content {
      position: relative;
    }
    
    .content-preview {
      max-height: 200px;
      overflow: hidden;
      position: relative;
    }
    
    .content-preview.collapsed::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: linear-gradient(transparent, rgba(255,255,255,0.9));
      pointer-events: none;
    }
    
    .expand-btn, .collapse-btn, .copy-btn {
      background: #06d85f;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-top: 5px;
      margin-left: 5px;
      font-size: 12px;
    }
    
    .expand-btn:hover, .collapse-btn:hover, .copy-btn:hover {
      background: #2cffbd;
    }
    
    .content-full {
      max-height: none;
    }

    /* JSONæ ‘å½¢å±•ç¤ºæ ·å¼ */
    .json-tree {
      font-family: monospace;
      line-height: 1.5;
    }
    
    .json-key {
      color: #881391;
      font-weight: bold;
    }
    
    .json-string {
      color: #C41E3A;
    }
    
    .json-number {
      color: #1C00CF;
    }
    
    .json-boolean {
      color: #0D7377;
    }
    
    .json-null {
      color: #808080;
    }
    
    .json-toggle {
      cursor: pointer;
      user-select: none;
      color: #666;
      font-weight: bold;
      margin-right: 5px;
    }
    
    .json-toggle:hover {
      background: #f0f0f0;
    }
    
    .json-collapsed {
      display: none;
    }
    
    .json-item {
      margin-left: 20px;
    }
    
    .json-bracket {
      color: #666;
      font-weight: bold;
    }
    
    .json-lazy-placeholder {
      color: #999;
      font-style: italic;
      cursor: pointer;
      padding: 2px 4px;
      background: #f5f5f5;
      border-radius: 3px;
      display: inline-block;
      margin: 2px;
    }
    
    .json-lazy-placeholder:hover {
      background: #e0e0e0;
      color: #666;
    }

  </style>
</head>

<body>
  <h1>Test Report: {{html_report_name}}</h1>

  <h2>Summary</h2>
  <table id="summary">
    <tr>
      <th>START AT</th>
      <td colspan="4">{{time.start_datetime}}</td>
    </tr>
    <tr>
      <th>DURATION</th>
      <td colspan="4">{{ '%0.3f'| format(time.duration|float) }} seconds</td>
    </tr>
    <tr>
      <th>PLATFORM</th>
      <td>HttpRunner {{ platform.httprunner_version }} </td>
      <td>{{ platform.python_version }} </td>
      <td colspan="2">{{ platform.platform }}</td>
    </tr>
    <tr>
      <th>STAT</th>
      <th colspan="2">TESTCASES (success/fail)</th>
      <th colspan="2">TESTSTEPS (success/fail/error/skip)</th>
    </tr>
    <tr>
      <td>total (details) =></td>
      <td colspan="2">{{stat.testcases.total}} ({{stat.testcases.success}}/{{stat.testcases.fail}})</td>
      <td colspan="2">{{stat.teststeps.total}} ({{stat.teststeps.successes}}/{{stat.teststeps.failures}}/{{stat.teststeps.errors}}/{{stat.teststeps.skipped}})</td>
    </tr>
  </table>

  <h2>Details</h2>

  {% for test_suite_summary in details %}
  {% set suite_index = loop.index %}
  <h3>{{test_suite_summary.name}}</h3>
  <table id="suite_{{suite_index}}" class="details">
    <tr>
      <td>TOTAL: {{test_suite_summary.stat.total}}</td>
      <td>SUCCESS: {{test_suite_summary.stat.successes}}</td>
      <td>FAILED: {{test_suite_summary.stat.failures}}</td>
      <td>ERROR: {{test_suite_summary.stat.errors}}</td>
      <td>SKIPPED: {{test_suite_summary.stat.skipped}}</td>
    </tr>
    <tr>
      <th>Status</th>
      <th colspan="2">Name</th>
      <th>Response Time</th>
      <th>Detail</th>
    </tr>

    {% for record in test_suite_summary.records %}
    {% set record_index = "{}_{}".format(suite_index, loop.index) %}
    {% set record_meta_datas = record.meta_datas_expanded %}
    <tr id="record_{{record_index}}">
      <th class="{{record.status}}" style="width:5em;">{{record.status}}</th>
      <td colspan="2">{{record.name}}</td>
      <td style="text-align:center;width:6em;">{{ record.response_time }} ms</td>
      <td class="detail">

        {% for meta_data in record_meta_datas %}
        {% set meta_data_index = "{}_{}".format(record_index, loop.index) %}
        <a class="button" href="#popup_log_{{meta_data_index}}">log-{{loop.index}}</a>
        <div id="popup_log_{{meta_data_index}}" class="overlay">
          <div class="popup">
            <h2>Request and Response data</h2>
            <a class="close" href="#record_{{meta_data_index}}">&times;</a>

            <div class="content">
              <h3>Name: {{ meta_data.name }}</h3>

              {% for req_resp in meta_data.data %}

              {% if loop.index > 1 %}
              <div class="separator">==================================== redirect to ====================================</div>
              {% endif %}

              <h3>Request:</h3>
              <div style="overflow: auto">
                <table>
                  {% for key, value in req_resp.request.items() %}
                    <tr>
                      <th>{{key}}</th>
                      <td>
                        {% if key in ["headers", "body"] %}
                            <pre>{{ value | e }}</pre>
                        {% else %}
                            {{value}}
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </table>
              </div>

              <h3>Response:</h3>
              <div style="overflow: auto">
                <table>
                    {% for key, value in req_resp.response.items() %}
                      <tr>
                        <th>{{key}}</th>
                        <td>
                          {% if key  == "headers" %}
                            <pre>{{ value | e }}</pre>
                          {% elif key == "body" %}
                            {% if "image" in req_resp.response.content_type %}
                              <img src="{{ req_resp.response.content }}" />
                            {% else %}
                              <pre>{{ value | e }}</pre>
                            {% endif %}
                          {% else %}
                            {{ value }}
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </table>
              </div>
              {% endfor %}

              <h3>Validators:</h3>
                <div style="overflow: auto">
                {% set validate_extractors = meta_data.validators.validate_extractor %}
                {% if validate_extractors %}
                <table>
                    <tr>
                      <th>check</th>
                      <th>comparator</th>
                      <th>expect value</th>
                      <th>actual value</th>
                    </tr>
                    {% for validator in validate_extractors %}
                    <tr>
                      {% if validator.check_result == "pass" %}
                      <td class="passed">
                      {% elif validator.check_result == "fail" %}
                      <td class="failed">
                      {% elif validator.check_result == "unchecked" %}
                      <td class="unchecked">
                      {% endif %}
                        <pre>{{validator.check | e}}</pre>
                      </td>
                      <td>{{validator.comparator}}</td>
                      <td><pre>{{validator.expect | e}}</pre></td>
                      <td><pre>{{validator.check_value | e}}</pre></td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}

                {% set validate_script = meta_data.validators.validate_script %}
                {% if validate_script %}
                    <h3>Scripts:</h3>
                    {% if validate_script.details %}
                    <!-- æ–°ç‰ˆé€æ¡æ˜¾ç¤ºçš„validate_scriptç»“æœ -->
                    <table>
                        <tr>
                            <th>script</th>
                            <th>output</th>
                        </tr>
                        {% for script_item in validate_script.details %}
                        <tr>
                            {% if script_item.check_result == "pass" %}
                            <td class="passed"><pre>{{script_item.script | e}}</pre></td>
                            {% elif script_item.check_result == "fail" %}
                            <td class="failed"><pre>{{script_item.script | e}}</pre></td>
                            {% endif %}
                            <td><pre>{{script_item.output | e}}</pre></td>
                        </tr>
                        {% endfor %}
                    </table>
                    {% else %}
                    <!-- æ—§ç‰ˆæ•´ä½“æ˜¾ç¤ºçš„validate_scriptç»“æœï¼ˆå‘åå…¼å®¹ï¼‰ -->
                    <table>
                        <tr>
                            <th>validate script</th><th>output</th>
                        </tr>
                        <tr>
                            <td><pre>{{validate_script.validate_script | safe}}</pre></td>
                            {% if validate_script.check_result == "pass" %}
                            <td class="passed">
                            {% elif validate_script.check_result == "fail" %}
                            <td class="failed">
                            {% endif %}
                            {{validate_script.output}}
                            </td>
                        </tr>
                    </table>
                    {% endif %}
                {% endif %}
              </div>

              <h3>Statistics:</h3>
              <div style="overflow: auto">
                <table>
                  <tr>
                      <th>content_size(bytes)</th>
                      <td>{{ meta_data.stat.content_size }}</td>
                    </tr>
                  <tr>
                    <th>response_time(ms)</th>
                    <td>{{ meta_data.stat.response_time_ms }}</td>
                  </tr>
                  <tr>
                    <th>elapsed(ms)</th>
                    <td>{{ meta_data.stat.elapsed_ms }}</td>
                  </tr>
                </table>
              </div>

            </div>
          </div>
        </div>
        {% endfor %}

        {% if record.attachment %}
          <a class="button" href="#popup_attachment_{{record_index}}">traceback</a>
          <div id="popup_attachment_{{record_index}}" class="overlay">
            <div class="popup">
              <h2>Traceback Message</h2>
              <a class="close" href="#record_{{record_index}}">&times;</a>
              <div class="content"><pre>{{ record.attachment | e }}</pre></div>
            </div>
          </div>
        {% endif %}

      </td>
    </tr>
  {% endfor %}
  </table>
  {% endfor %}

<script>
// åˆ¤æ–­æ˜¯å¦ä¸ºJSONå­—ç¬¦ä¸²æˆ–ç±»JSONå­—ç¬¦ä¸²
function isJsonString(str) {
  try {
    var obj = JSON.parse(str);
    return typeof obj === 'object' && obj !== null;
  } catch (e) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯Pythonå­—å…¸æ ¼å¼çš„å­—ç¬¦ä¸²
    var trimmed = str.trim();
    if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || 
        (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
      // å°è¯•å°†Pythonæ ¼å¼è½¬æ¢ä¸ºJSONæ ¼å¼
      try {
        var converted = trimmed
          .replace(/'/g, '"')           // å•å¼•å·è½¬åŒå¼•å·
          .replace(/None/g, 'null')     // Python Noneè½¬null
          .replace(/True/g, 'true')     // Python Trueè½¬true
          .replace(/False/g, 'false');  // Python Falseè½¬false
        JSON.parse(converted);
        return true;
      } catch (e2) {
        return false;
      }
    }
    return false;
  }
}

// å®½æ¾è§£æï¼šåŒæ—¶æ”¯æŒä¸¥æ ¼ JSON ä¸ Python å­—å…¸é£æ ¼ï¼ˆå•å¼•å·ã€None/True/Falseï¼‰
function tryParseJsonOrPythonLike(str) {
  if (!str) return null;
  var trimmed = str.trim();

  // 1) ä¸¥æ ¼ JSON ç›´æ¥è§£æ
  try {
    return JSON.parse(trimmed);
  } catch (e1) {}

  // 2) Python -> JSON ç®€å•æ›¿æ¢å†è§£æï¼ˆä¿ç•™åŒå¼•å·ä¸åŠ¨ï¼Œé¿å…ç ´åå·²åˆæ³•å†…å®¹ï¼‰
  try {
    var convertedForJson = trimmed
      .replace(/\bNone\b/g, 'null')
      .replace(/\bTrue\b/g, 'true')
      .replace(/\bFalse\b/g, 'false')
      // å…ˆå°†é”®åçš„å•å¼•å·æ›¿æ¢ä¸ºåŒå¼•å·ï¼š'key': â†’ "key":
      .replace(/'([^'\\]*(?:\\.[^'\\]*)*)'\s*:/g, function(_, key){
        return '"' + key.replace(/\\"/g, '"') + '"' + ':';
      })
      // å†å°½é‡å°†ä½œä¸ºå€¼çš„çº¯å•å¼•å·å­—ç¬¦ä¸²æ›¿æˆåŒå¼•å·ï¼ˆé¿å…ç ´åå·²ç»æ˜¯åŒå¼•å·çš„å€¼ï¼‰ï¼š
      .replace(/:\s*'([^'\\]*(?:\\.[^'\\]*)*)'(?=\s*[\]\},])/g, function(_, val){
        return ': "' + val.replace(/\\"/g, '"') + '"';
      })
      // æ•°ç»„ä¸­çš„å€¼ï¼ˆä»¥é€—å·æˆ–[å¼€å§‹ï¼‰
      .replace(/([\[,]\s*)'([^'\\]*(?:\\.[^'\\]*)*)'(?=\s*[\]\},])/g, function(_, prefix, val){
        return prefix + '"' + val.replace(/\\"/g, '"') + '"';
      });

    return JSON.parse(convertedForJson);
  } catch (e2) {}

  // 3) æœ€åå…œåº•ï¼šåœ¨å®‰å…¨å­—ç¬¦æ£€æŸ¥é€šè¿‡åï¼ŒæŒ‰ JS å­—é¢é‡æ±‚å€¼ï¼ˆä»…å½“å½¢å¦‚ { ... } æˆ– [ ... ]ï¼‰
  try {
    var startsOk = (trimmed.startsWith('{') && trimmed.endsWith('}')) || (trimmed.startsWith('[') && trimmed.endsWith(']'));
    if (!startsOk) return null;

    // åŸºç¡€å®‰å…¨æ£€æŸ¥ï¼šç¦æ­¢æ˜æ˜¾å¯æ‰§è¡Œè¯­å¥æˆ–å±é™©ç¬¦å·
    var forbidden = /[;=<>`$]|\bfunction\b|\bconstructor\b|\bwhile\b|\bfor\b|\bclass\b|\bimport\b|=>/;
    if (forbidden.test(trimmed)) return null;

    var jsLiteral = trimmed
      .replace(/\bNone\b/g, 'null')
      .replace(/\bTrue\b/g, 'true')
      .replace(/\bFalse\b/g, 'false');

    // ä½¿ç”¨ Function è¿”å›å¯¹è±¡å­—é¢é‡
    return (new Function('return (' + jsLiteral + ')'))();
  } catch (e3) {}

  return null;
}

// åˆ›å»ºJSONæ ‘å½¢ç»“æ„ - ä¼˜åŒ–ç‰ˆæœ¬
function createJsonTreeLazy(obj, depth = 0) {
  if (depth > 10) return '<span class="json-string">...</span>'; // é˜²æ­¢é€’å½’è¿‡æ·±
  
  if (obj === null) {
    return '<span class="json-null">null</span>';
  }
  
  if (typeof obj === 'string') {
    return '<span class="json-string">"' + escapeHtml(obj) + '"</span>';
  }
  
  if (typeof obj === 'number') {
    return '<span class="json-number">' + obj + '</span>';
  }
  
  if (typeof obj === 'boolean') {
    return '<span class="json-boolean">' + obj + '</span>';
  }
  
  if (Array.isArray(obj)) {
    if (obj.length === 0) {
      return '<span class="json-bracket">[]</span>';
    }
    
    var id = 'json_' + Math.random().toString(36).substr(2, 9);
    var html = '<span class="json-bracket">[</span>';
    
    // å‰2å±‚é»˜è®¤å±•å¼€ï¼Œæ·±å±‚çº§éœ€è¦ç‚¹å‡»å±•å¼€
    var isExpanded = depth < 2;
    var toggleIcon = isExpanded ? 'â–¼' : 'â–¶';
    var itemClass = isExpanded ? 'json-item' : 'json-item json-collapsed';
    
    html += '<span class="json-toggle" onclick="toggleJsonNodeLazy(\'' + id + '\', this)" title="ç‚¹å‡»å±•å¼€/æŠ˜å ">' + toggleIcon + '</span>';
    html += '<div id="' + id + '" class="' + itemClass + '" data-obj="' + escapeHtml(JSON.stringify(obj)) + '" data-depth="' + depth + '">';
    
    // å‰2å±‚ç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼Œæ·±å±‚çº§ä½¿ç”¨å ä½ç¬¦
    if (depth < 2) {
      for (var i = 0; i < obj.length; i++) {
        html += '<div>' + createJsonTreeLazy(obj[i], depth + 1);
        if (i < obj.length - 1) html += ',';
        html += '</div>';
      }
    } else {
      html += '<div class="json-lazy-placeholder">ç‚¹å‡»å±•å¼€æŸ¥çœ‹ ' + obj.length + ' é¡¹...</div>';
    }
    
    html += '</div><span class="json-bracket">]</span>';
    return html;
  }
  
  if (typeof obj === 'object') {
    var keys = Object.keys(obj);
    if (keys.length === 0) {
      return '<span class="json-bracket">{}</span>';
    }
    
    var id = 'json_' + Math.random().toString(36).substr(2, 9);
    var html = '<span class="json-bracket">{</span>';
    
    // å‰2å±‚é»˜è®¤å±•å¼€ï¼Œæ·±å±‚çº§éœ€è¦ç‚¹å‡»å±•å¼€
    var isExpanded = depth < 2;
    var toggleIcon = isExpanded ? 'â–¼' : 'â–¶';
    var itemClass = isExpanded ? 'json-item' : 'json-item json-collapsed';
    
    html += '<span class="json-toggle" onclick="toggleJsonNodeLazy(\'' + id + '\', this)" title="ç‚¹å‡»å±•å¼€/æŠ˜å ">' + toggleIcon + '</span>';
    html += '<div id="' + id + '" class="' + itemClass + '" data-obj="' + escapeHtml(JSON.stringify(obj)) + '" data-depth="' + depth + '">';
    
    // å‰2å±‚ç›´æ¥æ˜¾ç¤ºå†…å®¹ï¼Œæ·±å±‚çº§ä½¿ç”¨å ä½ç¬¦
    if (depth < 2) {
      for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        html += '<div><span class="json-key">"' + escapeHtml(key) + '"</span>: ' + createJsonTreeLazy(obj[key], depth + 1);
        if (i < keys.length - 1) html += ',';
        html += '</div>';
      }
    } else {
      html += '<div class="json-lazy-placeholder">ç‚¹å‡»å±•å¼€æŸ¥çœ‹ ' + keys.length + ' ä¸ªå±æ€§...</div>';
    }
    
    html += '</div><span class="json-bracket">}</span>';
    return html;
  }
  
  return '<span class="json-string">' + escapeHtml(String(obj)) + '</span>';
}


// åˆ‡æ¢JSONèŠ‚ç‚¹çš„å±•å¼€/æŠ˜å çŠ¶æ€ - æ‡’åŠ è½½ç‰ˆæœ¬
function toggleJsonNodeLazy(id, toggleElement) {
  var element = document.getElementById(id);
  
  if (element.classList.contains('json-collapsed')) {
    // å±•å¼€èŠ‚ç‚¹
    element.classList.remove('json-collapsed');
    toggleElement.innerHTML = 'â–¼';
    toggleElement.title = 'ç‚¹å‡»æŠ˜å ';
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ‡’åŠ è½½å†…å®¹
    var placeholder = element.querySelector('.json-lazy-placeholder');
    if (placeholder) {
      // éœ€è¦æ‡’åŠ è½½ï¼Œæ›¿æ¢å ä½ç¬¦ä¸ºå®é™…å†…å®¹
      loadJsonNodeContent(element, placeholder);
    }
  } else {
    // æŠ˜å èŠ‚ç‚¹
    element.classList.add('json-collapsed');
    toggleElement.innerHTML = 'â–¶';
    toggleElement.title = 'ç‚¹å‡»å±•å¼€';
  }
}

// æ‡’åŠ è½½JSONèŠ‚ç‚¹å†…å®¹
function loadJsonNodeContent(element, placeholder) {
  try {
    var objData = element.getAttribute('data-obj');
    var depth = parseInt(element.getAttribute('data-depth')) || 0;
    
    if (objData) {
      var obj = JSON.parse(unescapeHtml(objData));
      
      // æ¸…ç©ºç°æœ‰å†…å®¹
      element.innerHTML = '';
      
      // ç”Ÿæˆå®é™…å†…å®¹
      if (Array.isArray(obj)) {
        for (var i = 0; i < obj.length; i++) {
          var div = document.createElement('div');
          div.innerHTML = createJsonTreeLazy(obj[i], depth + 1);
          if (i < obj.length - 1) div.innerHTML += ',';
          element.appendChild(div);
        }
      } else if (typeof obj === 'object' && obj !== null) {
        var keys = Object.keys(obj);
        for (var i = 0; i < keys.length; i++) {
          var key = keys[i];
          var div = document.createElement('div');
          div.innerHTML = '<span class="json-key">"' + escapeHtml(key) + '"</span>: ' + createJsonTreeLazy(obj[key], depth + 1);
          if (i < keys.length - 1) div.innerHTML += ',';
          element.appendChild(div);
        }
      }
    }
  } catch (e) {
    console.error('Failed to load JSON node content:', e);
    placeholder.textContent = 'åŠ è½½å¤±è´¥';
  }
}


// HTMLè½¬ä¹‰
function escapeHtml(text) {
  var map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// HTMLå®ä½“è§£ç  - å®Œæ•´ç‰ˆ
function unescapeHtml(text) {
  // å…ˆå¤„ç†æ•°å­—ç¼–ç çš„å®ä½“
  text = text.replace(/&#(\d+);/g, function(match, dec) {
    return String.fromCharCode(dec);
  });
  
  // å†å¤„ç†åå…­è¿›åˆ¶ç¼–ç çš„å®ä½“
  text = text.replace(/&#x([0-9a-fA-F]+);/g, function(match, hex) {
    return String.fromCharCode(parseInt(hex, 16));
  });
  
  // æœ€åå¤„ç†å‘½åå®ä½“
  var map = {
    '&amp;': '&',
    '&lt;': '<',
    '&gt;': '>',
    '&quot;': '"',
    '&apos;': "'",
    '&#039;': "'",
    '&#39;': "'",
    '&nbsp;': ' '
  };
  
  return text.replace(/&amp;|&lt;|&gt;|&quot;|&apos;|&#039;|&#39;|&nbsp;/g, function(m) { return map[m]; });
}

// å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿ï¼ˆå¸¦é™çº§æ–¹æ¡ˆï¼‰
function copyTextToClipboard(text) {
  if (!text && text !== '') return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).catch(function() {
      fallbackCopyText(text);
    });
  } else {
    fallbackCopyText(text);
  }
}

function fallbackCopyText(text) {
  try {
    var textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.top = '-9999px';
    textarea.style.left = '-9999px';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    document.execCommand('copy');
  } finally {
    if (textarea && textarea.parentNode) {
      textarea.parentNode.removeChild(textarea);
    }
  }
}

// å¤„ç†å†…å®¹çš„æŠ˜å å±•å¼€ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå¤„ç†æŒ‡å®šå¼¹çª—å†…æ‰€æœ‰preå…ƒç´ 
function setupCollapsibleContentForPopup(popup) {
  // é€‰æ‹©å¼¹çª—å†…çš„æ‰€æœ‰preå…ƒç´ ï¼ˆåŒ…æ‹¬éªŒè¯å™¨è¡¨æ ¼ä¸­çš„ï¼‰
  var preElements = popup.querySelectorAll('pre');
  var totalElements = preElements.length;
  var processedCount = 0;
  
  // åˆ†ç‰‡å¤„ç†ï¼Œé¿å…é˜»å¡UI
  function processBatch(startIndex) {
    var batchSize = Math.min(5, totalElements - startIndex); // æ¯æ‰¹å¤„ç†5ä¸ªå…ƒç´ 
    var endIndex = startIndex + batchSize;
    
    for (var i = startIndex; i < endIndex && i < totalElements; i++) {
      processPreElement(preElements[i]);
      processedCount++;
    }
    
    // å¦‚æœè¿˜æœ‰æ›´å¤šå…ƒç´ éœ€è¦å¤„ç†ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹
    if (endIndex < totalElements) {
      requestAnimationFrame(function() {
        processBatch(endIndex);
      });
    }
  }
  
  // å¼€å§‹åˆ†ç‰‡å¤„ç†
  if (totalElements > 0) {
    processBatch(0);
  }
}

// å¤„ç†å•ä¸ªpreå…ƒç´ 
function processPreElement(pre) {
  var content = pre.textContent || pre.innerText;
  // å…ˆè¿›è¡ŒHTMLå®ä½“è§£ç ï¼Œå¤„ç†HTMLæ¨¡æ¿ä¸­çš„è½¬ä¹‰å­—ç¬¦
  var decodedContent = unescapeHtml(content);
  var processedElement = pre;
  var finalContent = decodedContent;
  
  // è·³è¿‡è¿‡çŸ­çš„å†…å®¹ï¼Œé¿å…å¤„ç†ç®€å•æ–‡æœ¬
  if (decodedContent.trim().length < 10) {
    return;
  }
  
  
  // æ­¥éª¤1ï¼šå¦‚æœæ˜¯JSON/Pythonå­—å…¸ï¼Œè½¬æ¢ä¸ºæ ‘å½¢ç»“æ„
  try {
    var parsedObj = tryParseJsonOrPythonLike(decodedContent.trim());
    if (parsedObj !== null) {
      var jsonHtml = createJsonTreeLazy(parsedObj, 0); // ä½¿ç”¨æ‡’åŠ è½½ç‰ˆæœ¬
      var jsonDiv = document.createElement('div');
      jsonDiv.className = 'json-tree';
      jsonDiv.innerHTML = jsonHtml;
      pre.parentNode.replaceChild(jsonDiv, pre);
      processedElement = jsonDiv;
      // ä½¿ç”¨æ ¼å¼åŒ–åçš„JSONå­—ç¬¦ä¸²è®¡ç®—è¡Œæ•°
      var formattedJson = JSON.stringify(parsedObj, null, 2);
      finalContent = formattedJson;
    }
  } catch (e) {
    // è§£æå¤±è´¥åˆ™ä¿æŒåŸæ ·
  }
  
  // æ­¥éª¤2ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æŠ˜å ï¼ˆè½¬æ¢åè¶…è¿‡10è¡Œï¼‰
  var lineCount = finalContent.split('\n').length;
  
  if (lineCount > 10) {
    var wrapper = document.createElement('div');
    wrapper.className = 'collapsible-content';
    
    var preview = document.createElement('div');
    preview.className = 'content-preview collapsed';
    preview.appendChild(processedElement.cloneNode(true));
    
    var expandBtn = document.createElement('button');
    expandBtn.className = 'expand-btn';
    expandBtn.textContent = 'å±•å¼€ (' + lineCount + ' è¡Œ)';
    
    expandBtn.onclick = function() {
      preview.classList.remove('collapsed');
      preview.classList.add('content-full');
      expandBtn.style.display = 'none';
      collapseBtn.style.display = 'inline-block';
    };
    
    var collapseBtn = document.createElement('button');
    collapseBtn.className = 'collapse-btn';
    collapseBtn.textContent = 'æŠ˜å ';
    collapseBtn.style.display = 'none';
    collapseBtn.onclick = function() {
      preview.classList.add('collapsed');
      preview.classList.remove('content-full');
      expandBtn.style.display = 'inline-block';
      collapseBtn.style.display = 'none';
    };

    var copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.textContent = 'å¤åˆ¶';
    copyBtn.onclick = function() {
      copyTextToClipboard(finalContent);
      var prev = copyBtn.textContent;
      copyBtn.textContent = 'å·²å¤åˆ¶';
      setTimeout(function(){ copyBtn.textContent = prev; }, 1200);
    };
    
    wrapper.appendChild(preview);
    wrapper.appendChild(expandBtn);
    wrapper.appendChild(collapseBtn);
    wrapper.appendChild(copyBtn);
    
    processedElement.parentNode.replaceChild(wrapper, processedElement);
  }
}


// å­˜å‚¨å·²å¤„ç†çš„å¼¹çª—ï¼Œé¿å…é‡å¤å¤„ç†
var processedPopups = new Set();

// æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿ŸåŠ è½½å’ŒæŒ‰éœ€å¤„ç†
// ç§»é™¤å…¨å±€åˆå§‹åŒ–ï¼Œæ”¹ä¸ºæŒ‰éœ€å¤„ç†

// æŒ‰éœ€å¤„ç†å•ä¸ªå¼¹çª—çš„å†…å®¹
function processPopupContent(popupId) {
  if (processedPopups.has(popupId)) {
    return; // å·²ç»å¤„ç†è¿‡çš„å¼¹çª—ï¼Œè·³è¿‡
  }
  
  var popup = document.getElementById(popupId);
  if (!popup) {
    return;
  }
  
  // æ ‡è®°ä¸ºå·²å¤„ç†
  processedPopups.add(popupId);
  
  // æ€§èƒ½ç›‘æ§ï¼šå¼€å§‹è®¡æ—¶
  var startTime = performance.now();
  
  // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
  var loadingIndicator = createLoadingIndicator();
  var popupContent = popup.querySelector('.content');
  if (popupContent) {
    popupContent.appendChild(loadingIndicator);
  }
  
  // ä½¿ç”¨ requestAnimationFrame è¿›è¡Œéé˜»å¡å¤„ç†
  requestAnimationFrame(function() {
    try {
      setupCollapsibleContentForPopup(popup);
    } finally {
      // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
      if (loadingIndicator && loadingIndicator.parentNode) {
        loadingIndicator.parentNode.removeChild(loadingIndicator);
      }
      
      // æ€§èƒ½ç›‘æ§ï¼šè®°å½•å¤„ç†æ—¶é—´
      var endTime = performance.now();
      var processingTime = endTime - startTime;
      performanceStats.processedPopups++;
      performanceStats.totalProcessingTime += processingTime;
      
      // é¦–æ¬¡å¤„ç†æ—¶æ˜¾ç¤ºæ€§èƒ½ç»Ÿè®¡
      if (performanceStats.processedPopups === 1) {
        setTimeout(showPerformanceStats, 100);
      }
    }
  });
}

// åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
function createLoadingIndicator() {
  var indicator = document.createElement('div');
  indicator.style.cssText = 'padding: 10px; text-align: center; color: #666; font-size: 14px;';
  indicator.innerHTML = 'â³ æ­£åœ¨å¤„ç†å†…å®¹ï¼Œè¯·ç¨å€™...';
  return indicator;
}

// æ€§èƒ½ç›‘æ§
var performanceStats = {
  processedPopups: 0,
  totalProcessingTime: 0,
  startTime: Date.now()
};

// æ·»åŠ æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯åˆ°é¡µé¢
function showPerformanceStats() {
  var statsDiv = document.createElement('div');
  statsDiv.style.cssText = 'position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 9999;';
  statsDiv.innerHTML = 'ğŸ“Š æ€§èƒ½ç»Ÿè®¡<br>å·²å¤„ç†å¼¹çª—: ' + performanceStats.processedPopups + '<br>æ€»å¤„ç†æ—¶é—´: ' + performanceStats.totalProcessingTime.toFixed(2) + 'ms<br>é¡µé¢åŠ è½½æ—¶é—´: ' + (Date.now() - performanceStats.startTime).toFixed(0) + 'ms';
  
  document.body.appendChild(statsDiv);
  
  // 3ç§’åéšè—ç»Ÿè®¡ä¿¡æ¯
  setTimeout(function() {
    if (statsDiv && statsDiv.parentNode) {
      statsDiv.parentNode.removeChild(statsDiv);
    }
  }, 3000);
}

// ç›‘å¬å¼¹çª—ç‚¹å‡»äº‹ä»¶ï¼Œå»¶è¿Ÿå¤„ç†å†…å®¹
document.addEventListener('DOMContentLoaded', function() {
  // ä¸ºæ‰€æœ‰logæŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
  var logButtons = document.querySelectorAll('a.button[href^="#popup_log_"]');
  logButtons.forEach(function(button) {
    button.addEventListener('click', function(e) {
      var popupId = this.getAttribute('href').substring(1); // ç§»é™¤å¼€å¤´çš„#
      // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´ç­‰å¾…å¼¹çª—æ˜¾ç¤ºï¼Œç„¶åå¤„ç†å†…å®¹
      setTimeout(function() {
        processPopupContent(popupId);
      }, 50);
    });
  });
});
</script>
</body>